<div class="container bg-white ">
  <div class="movie-page-box">
    <div class="contain mt-5">
      <div class="row  position-relative">
        <!-- Backdrop -->
        <div style="position: relative; width: 100%;">
          <img *ngIf="getMovieDetailResult?.backdrop_path" src="https://image.tmdb.org/t/p/original/{{ getMovieDetailResult.backdrop_path }}" class="backdrop-image" alt="Backdrop Image">
          <ng-template #defaultImage>
            <img src="../assets/img/55b4a4b5-217a-4408-8934-c611fc89c423.jpg" class="backdrop-image" alt="Default Backdrop Image">
          </ng-template>
          <img *ngIf="getMovieDetailResult?.poster_path" src="https://image.tmdb.org/t/p/original/{{ getMovieDetailResult.poster_path }}" class="poster-image" alt="Poster Image">
          <ng-template #defaultPoster>
            <img src="../assets/img/default_media_pic.jpg" class="poster-image" alt="Default Poster Image">
          </ng-template>
        </div>

        <!-- Movie Details -->
        <div class="col-lg-10 mt-5 p-4">
          <div class="d-flex justify-content-between align-items-center">
            <h1 class="mt-2 mb-2">{{getMovieDetailResult?.title}}</h1>

            <div class="buttons-container" style="margin-right:-15%;" *ngIf="currentUser">
              <button class="expand-button" *ngIf="!isToWatchLater" (click)="markAsWatched()">{{ isWatched ? 'Remover dos Assistidos' : 'Marcar como Assistido' }}</button>
              <button class="expand-button" *ngIf="!isWatched" (click)="markToWatchLater()">{{ isToWatchLater ? 'Remover de Assistir Mais Tarde' : 'Assistir Mais Tarde' }}</button>
            </div>
          </div>

          <div class="container">
            <div class="row">
              <h6 class="mt-2 mb-2">Nome Original: <strong>{{getMovieDetailResult?.original_title}}</strong></h6>
              <div class="  category-div">
                <p class="genre-p" *ngFor="let genre of getMovieDetailResult?.genres; let last = last">
                  {{ genre.name }}<span *ngIf="!last">,</span>
                </p>
              </div>
              <div class="col-md-6">
                <div>
                  <p class="manual-text mt-2 mb-1">Duração:</p>
                  <p class="movie-details mt-1 mb-2">{{convertMinutesToHours(getMovieDetailResult?.runtime)}}</p>

                  <p class="manual-text mt-2 mb-1">Classificação Geral dos Utilizadores:</p>
                  <p class="movie-details mt-1 mb-2">{{convertToPercentage(getMovieDetailResult?.vote_average)}}</p>

                  <p class="manual-text mt-2 mb-1">Sinopse:</p>
                  <p class="movie-details-sinopse mt-1 mb-2">{{getMovieDetailResult?.overview}}</p>
                </div>
              </div>

              <div class="col-md-6">
                <p class="manual-text mt-2 mb-1">Orçamento:</p>
                <p class="movie-details mt-1 mb-2">{{ getMovieDetailResult?.budget | currency:'USD' }}</p>

                <p class="manual-text mt-2 mb-1">Estado:</p>
                <p class="movie-details mt-1 mb-2">{{ getMovieDetailResult?.status }}</p>

                <p class="manual-text mt-2 mb-1">Receita:</p>
                <p class="movie-details mt-1 mb-2">{{ getMovieDetailResult?.revenue | currency:'USD' }}</p>
              </div>


            </div>

          </div>

          <div class="mt-3 mb-3 genre-p" *ngIf="getMovieProviders?.flatrate?.length">
            Onde Ver:
            <p class="ps" *ngFor="let provider of getMovieProviders.flatrate; let last = last">
              <img src="https://image.tmdb.org/t/p/original/{{  provider?.logo_path }}" class="provider-logo">
              {{ provider?.provider_name }}
            </p>
          </div>
          <div *ngIf="!getMovieProviders?.flatrate?.length">
            Onde Ver:
            Ainda não existem provedores de streaming disponíveis.
          </div>

          <div class="rating-container">
            <p class="manual-text mt-2 mb-1">Classificação Média:</p>
            <p class="movie-details mt-1 mb-2">{{ averageRating }}  <i class="fas fa-star"></i></p>
          </div>


          <div *ngIf="isWatched" class="rating-container">
            <p class="manual-text mt-2 mb-1">A sua avaliação:</p>
            <i class="fa-star" *ngFor="let star of [1, 2, 3, 4, 5]; let i = index"
               [class.fas]="userRating > i" [class.far]="userRating <= i"
               (click)="rateMovie(i + 1)"></i>
          </div>

          <div class="container">
            <h2 class="text-black">Principais atores</h2>
            <div class="d-flex flex-row flex-nowrap overflow-auto">
              <div class="card text-center flex-shrink-0" *ngFor="let c of getMovieCastResult">
                <div class="actor-image-container">
                  <img class="img-fluid actor-image" *ngIf="c.profile_path; else defaultImage" src="https://image.tmdb.org/t/p/original/{{ c.profile_path }}">
                  <ng-template #defaultImage>
                    <img class="img-fluid actor-image default-image" src="../assets/img/vecteezy_simple-user-default-icon_24983914.png">
                  </ng-template>
                </div>
                <div class="card-body">
                  <!-- Exibir a estrela apenas se a mídia estiver marcada como assistida -->
                  <i *ngIf="isWatched" class="fa-star"
                     [class.fas]="isFavoriteActor(c.id)"
                     [class.far]="!isFavoriteActor(c.id)"
                     (click)="chooseFavoriteActor(c)"></i>
                  <h3 class="text-black">{{c?.original_name}}</h3>
                  <p class="text-black">{{c?.character}}</p>
                  <p class="text-black" *ngIf="actorVotePercentages[c.id]">{{ actorVotePercentages[c.id] }}% votos</p>
                </div>
              </div>
            </div>
          </div>

          <div class="comments-section mt-5" *ngIf="showComments">
            <h2 class="mb-4">Adicionar comentário</h2>

            <!-- Formulário de Novo Comentário -->
            <div class="comment-form mb-3">
              <textarea [(ngModel)]="newCommentText" placeholder="Escreva um comentário..." rows="3" class="form-control mb-2"></textarea>
              <button (click)="addComment()" class="btn btn-primary">Publicar Comentário</button>
            </div>

            <!-- Lista de Comentários -->
            <div class="comment-list" *ngIf="isWatched">
              <h2 class="mb-4">Comentários</h2>
              <h5 *ngIf="comments.length > 0" class="mb-4"> Número total de comentários: {{comments.length}}</h5>
              <div *ngFor="let comment of comments; let i = index" class="comment mb-4 p-3 bg-light rounded">
                <div class="d-flex justify-content-between">
                  <div class="user-info d-flex align-items-center">
                    <img *ngIf="comment?.profilePhoto; else defaultProfile" [src]="comment?.profilePhoto" class="img-fluid rounded-circle" style="width: 40px; height: 40px;" alt="User profile image">
                    <ng-template #defaultProfile>
                      <img src="../assets/img/joao-pfp.png" class="img-fluid rounded-circle" style="width: 40px; height: 40px;" alt="Default profile image">
                    </ng-template>
                    <strong *ngIf="comment?.userName">{{ comment.userName }}</strong>
                    <span class="text-muted" *ngIf="comment?.createdAt">em {{ comment.createdAt | date:'short' }}</span>
                  </div>
                  <button *ngIf="comment?.userName && canDeleteComment(comment.userName)" (click)="deleteComment(comment.id)" class="btn btn-danger mt-2">Apagar Comentário</button>
                </div>

                <p class="comment-text mt-2" style="margin-left:55px" *ngIf="comment?.text">{{ comment.text }}</p>
                <div class="comment-actions d-flex align-items-center" *ngIf="comment">
                  <button *ngIf="!comment.hasDisliked" (click)="toggleLikeComment(comment.id)" class="icon-button" [ngClass]="comment.hasLiked ? 'liked' : 'not-liked'">
                    <i class="fa fa-thumbs-up"></i>
                  </button>
                  <span class="likes-count" *ngIf="comment?.likesCount">{{comment.likesCount}}</span>
                </div>

                <div class="replies mt-3" *ngIf="comment?.replies">
                  <button *ngIf="!showReplyForms[comment.id]" (click)="toggleReplyForm(comment.id)" class="btn btn-outline-secondary">Responder</button>
                  <div *ngIf="showReplyForms[comment.id]" class="reply-form mt-2">
                    <textarea [(ngModel)]="replyTexts[comment.id]" class="form-control" placeholder="Escreva uma resposta..." rows="3"></textarea>
                    <button (click)="addReply(comment.id)" class="btn btn-secondary mt-2">Enviar Resposta</button>
                  </div>

                  <div *ngIf="comment.replies && comment.replies.length > 0" class="reply-list">
                    <div *ngFor="let reply of comment.replies" class="reply mb-3 p-2 bg-light rounded">
                      <div class="d-flex justify-content-between" style="margin-top:15px">
                        <div class="user-info d-flex align-items-center">
                          <img *ngIf="reply.profilePhoto; else defaultProfile" [src]="reply.profilePhoto" class="img-fluid rounded-circle" alt="Reply user profile image">
                          <strong>{{ reply?.userName }}</strong>
                          <span class="text-muted d-block" *ngIf="reply?.createdAt"> {{ reply?.createdAt | date:'short' }}</span>
                        </div>
                        <button *ngIf="canDeleteComment(reply.userName)" (click)="deleteComment(reply.id, comment.id)" class="btn btn-danger btn-sm">Apagar Resposta</button>
                      </div>

                      <p class="my-1" style="margin-left:45px" *ngIf="reply?.text">{{ reply?.text }}</p>
                      <div class="action-buttons d-flex align-items-center">
                        <button *ngIf="!reply.hasDisliked" (click)="toggleLikeComment(reply.id, comment.id)" class="icon-button" [ngClass]="reply.hasLiked ? 'liked' : 'not-liked'">
                          <i class="fa fa-thumbs-up"></i>
                        </button>
                        <span class="likes-count">{{reply?.likesCount}}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div *ngIf="comments.length === 0" class="text-muted text-center mt-3">Ainda não há comentários. Seja o primeiro a comentar!</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<br />
<br />
